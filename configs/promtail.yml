server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
- job_name: erpgo-logs
  static_configs:
  - targets:
      - localhost
    labels:
      job: erpgo-logs
      __path__: /var/log/erpgo/*.log

  pipeline_stages:
  - json:
      expressions:
        timestamp: timestamp
        level: level
        message: message
        component: component
        correlation_id: correlation_id
        trace_id: trace_id
        request_id: request_id
        user_id: user_id
        error: error

  - timestamp:
      source: timestamp
      format: RFC3339

  - labels:
      level:
      component:
      correlation_id:
      trace_id:
      request_id:
      user_id:

  - output:
      source: message

- job_name: nginx-access
  static_configs:
  - targets:
      - localhost
    labels:
      job: nginx-access
      __path__: /var/log/nginx/access.log

  pipeline_stages:
  - regex:
      expression: '(?P<remote_addr>\S+)\s+-\s+(?P<remote_user>\S+)\s+\[(?P<time_local>[^\]]+)\]\s+"(?P<method>\S+)\s+(?P<path>\S+)\s+(?P<protocol>\S+)"\s+(?P<status>\d+)\s+(?P<body_bytes_sent>\d+)\s+"(?P<http_referer>[^"]*)"\s+"(?P<http_user_agent>[^"]*)"'

  - labels:
      method:
      status:
      remote_addr:

  - output:
      source: message

- job_name: nginx-error
  static_configs:
  - targets:
      - localhost
    labels:
      job: nginx-error
      __path__: /var/log/nginx/error.log

  pipeline_stages:
  - regex:
      expression: '(?P<timestamp>\d{4}/\d{2}/\d{2}\s+\d{2}:\d{2}:\d{2})\s+\[(?P<level>\w+)\]\s+(?P<pid>\d+)#(?P<tid>\d+):\s+(?P<message>.*)'

  - timestamp:
      source: timestamp
      format: '2006/01/02 15:04:05'

  - labels:
      level:

  - output:
      source: message

- job_name: postgresql
  static_configs:
  - targets:
      - localhost
    labels:
      job: postgresql
      __path__: /var/log/postgresql/*.log

  pipeline_stages:
  - regex:
      expression: '(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d+)\s+\[(?P<pid>\d+)\]\s+(?P<level>\w+):\s+(?P<message>.*)'

  - timestamp:
      source: timestamp
      format: '2006-01-02 15:04:05.000'

  - labels:
      level:

  - output:
      source: message

- job_name: redis
  static_configs:
  - targets:
      - localhost
    labels:
      job: redis
      __path__: /var/log/redis/redis-server.log

  pipeline_stages:
  - regex:
      expression: '(?P<timestamp>\d+:\d+:\d+)\s+(?P<pid>\d+)\s+(?P<role>\S+)\s+(?P<message>.*)'

  - labels:
      role:

  - output:
      source: message

# Global limits and performance tuning
limit_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h

- job_name: system-logs
  static_configs:
  - targets:
      - localhost
    labels:
      job: system-logs
      __path__: /var/log/syslog

  pipeline_stages:
  - regex:
      expression: '(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<host>\S+)\s+(?P<process>\S+):\s*(?P<message>.*)'

  - timestamp:
      source: timestamp
      format: RFC3339

  - labels:
      host:
      process:

  - output:
      source: message

- job_name: nginx-access
  static_configs:
  - targets:
      - localhost
    labels:
      job: nginx-access
      __path__: /var/log/nginx/access.log

  pipeline_stages:
  - regex:
      expression: '(?P<remote_addr>\S+)\s+-\s+(?P<remote_user>\S+)\s+\[(?P<time_local>[^\]]+)\]\s+"(?P<method>\S+)\s+(?P<path>\S+)\s+(?P<protocol>\S+)"\s+(?P<status>\d+)\s+(?P<body_bytes_sent>\d+)\s+"(?P<http_referer>[^"]*)"\s+"(?P<http_user_agent>[^"]*)"'

  - labels:
      method:
      status:
      remote_addr:

  - output:
      source: message

- job_name: nginx-error
  static_configs:
  - targets:
      - localhost
    labels:
      job: nginx-error
      __path__: /var/log/nginx/error.log

  pipeline_stages:
  - regex:
      expression: '(?P<timestamp>\d{4}/\d{2}/\d{2}\s+\d{2}:\d{2}:\d{2})\s+\[(?P<level>\w+)\]\s+(?P<pid>\d+)#(?P<tid>\d+):\s+(?P<message>.*)'

  - timestamp:
      source: timestamp
      format: '2006/01/02 15:04:05'

  - labels:
      level:

  - output:
      source: message

- job_name: postgresql
  static_configs:
  - targets:
      - localhost
    labels:
      job: postgresql
      __path__: /var/log/postgresql/*.log

  pipeline_stages:
  - regex:
      expression: '(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d+)\s+\[(?P<pid>\d+)\]\s+(?P<level>\w+):\s+(?P<message>.*)'

  - timestamp:
      source: timestamp
      format: '2006-01-02 15:04:05.000'

  - labels:
      level:

  - output:
      source: message

- job_name: redis
  static_configs:
  - targets:
      - localhost
    labels:
      job: redis
      __path__: /var/log/redis/redis-server.log

  pipeline_stages:
  - regex:
      expression: '(?P<timestamp>\d+:\d+:\d+)\s+(?P<pid>\d+)\s+(?P<role>\S+)\s+(?P<message>.*)'

  - labels:
      role:

  - output:
      source: message

# Global limits and performance tuning
limit_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h

- job_name: docker-logs
  docker_sd_configs:
  - host: unix:///var/run/docker.sock
    refresh_interval: 5s
    port: 8080

  relabel_configs:
  - source_labels: ['__meta_docker_container_name']
    regex: '/(.*)'
    target_label: 'container'

  - source_labels: ['__meta_docker_container_log_stream']
    target_label: 'stream'

  pipeline_stages:
  - json:
      expressions:
        level: level
        message: message
        component: component
        correlation_id: correlation_id
        trace_id: trace_id

  - labels:
      level:
      component:
      correlation_id:
      trace_id:

  - output:
      source: message

- job_name: nginx-access
  static_configs:
  - targets:
      - localhost
    labels:
      job: nginx-access
      __path__: /var/log/nginx/access.log

  pipeline_stages:
  - regex:
      expression: '(?P<remote_addr>\S+)\s+-\s+(?P<remote_user>\S+)\s+\[(?P<time_local>[^\]]+)\]\s+"(?P<method>\S+)\s+(?P<path>\S+)\s+(?P<protocol>\S+)"\s+(?P<status>\d+)\s+(?P<body_bytes_sent>\d+)\s+"(?P<http_referer>[^"]*)"\s+"(?P<http_user_agent>[^"]*)"'

  - labels:
      method:
      status:
      remote_addr:

  - output:
      source: message

- job_name: nginx-error
  static_configs:
  - targets:
      - localhost
    labels:
      job: nginx-error
      __path__: /var/log/nginx/error.log

  pipeline_stages:
  - regex:
      expression: '(?P<timestamp>\d{4}/\d{2}/\d{2}\s+\d{2}:\d{2}:\d{2})\s+\[(?P<level>\w+)\]\s+(?P<pid>\d+)#(?P<tid>\d+):\s+(?P<message>.*)'

  - timestamp:
      source: timestamp
      format: '2006/01/02 15:04:05'

  - labels:
      level:

  - output:
      source: message

- job_name: postgresql
  static_configs:
  - targets:
      - localhost
    labels:
      job: postgresql
      __path__: /var/log/postgresql/*.log

  pipeline_stages:
  - regex:
      expression: '(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d+)\s+\[(?P<pid>\d+)\]\s+(?P<level>\w+):\s+(?P<message>.*)'

  - timestamp:
      source: timestamp
      format: '2006-01-02 15:04:05.000'

  - labels:
      level:

  - output:
      source: message

- job_name: redis
  static_configs:
  - targets:
      - localhost
    labels:
      job: redis
      __path__: /var/log/redis/redis-server.log

  pipeline_stages:
  - regex:
      expression: '(?P<timestamp>\d+:\d+:\d+)\s+(?P<pid>\d+)\s+(?P<role>\S+)\s+(?P<message>.*)'

  - labels:
      role:

  - output:
      source: message

# Global limits and performance tuning
limit_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h