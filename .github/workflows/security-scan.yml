name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install security scanning tools
      run: |
        # Install gosec (correct repository)
        go install github.com/securego/gosec/v2/cmd/gosec@latest

        # Install govulncheck
        go install golang.org/x/vuln/cmd/govulncheck@latest

        # Install staticcheck
        go install honnef.co/go/tools/cmd/staticcheck@latest

        # Install ineffassign
        go install github.com/gordonklaus/ineffassign@latest

        # Install misspell
        go install github.com/client9/misspell/cmd/misspell@latest

        # Install golangci-lint
        curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.54.2

        # Install trufflehog
        go install github.com/trufflesecurity/trufflehog/v3/cmd/trufflehog@latest

        # Install hadolint for Docker security
        wget -O hadolint https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
        chmod +x hadolint
        sudo mv hadolint /usr/local/bin/

        # Install trivy for container scanning
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install -y trivy

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Run go vet
      run: go vet ./...

    - name: Run govulncheck
      run: |
        echo "Running govulncheck for dependency vulnerabilities..."
        govulncheck ./...
        if [ $? -ne 0 ]; then
          echo "âŒ Critical or high severity vulnerabilities found"
          exit 1
        fi

    - name: Run gosec security scanner
      run: |
        mkdir -p security-reports
        gosec -conf .gosec.yml -fmt json -out security-reports/gosec-report.json -severity high -confidence medium ./...

    - name: Run staticcheck
      run: staticcheck ./...

    - name: Run ineffassign
      run: ineffassign ./...

    - name: Run misspell
      run: misspell -error .

    - name: Run golangci-lint
      run: |
        golangci-lint run --enable-all --disable=godot,exhaustivestruct,unused,wsl,exhaustruct,gochecknoglobals --timeout=5m || true

    - name: Run trufflehog secrets scan
      run: |
        trufflehog filesystem . --exclude "vendor/*,test*,*.md,*.txt,*.json,*.yml,*.yaml,node_modules,.git/*" --json --output security-reports/trufflehog-report.json || true

    - name: Run Docker security scan
      if: hashFiles('Dockerfile') != ''
      run: hadolint Dockerfile || true

    - name: Run comprehensive security audit
      run: |
        chmod +x scripts/comprehensive-security-audit.sh
        ./scripts/comprehensive-security-audit.sh || true

    - name: Upload security scan reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: security-reports/
        retention-days: 30

    - name: Comment PR with security results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = './security-reports';

          let comment = '## ðŸ”’ Security Scan Results\n\n';

          // Check for gosec results
          if (fs.existsSync(`${path}/gosec-report.json`)) {
            const gosecReport = JSON.parse(fs.readFileSync(`${path}/gosec-report.json`, 'utf8'));
            const issues = gosecReport.Issues || [];
            comment += `### gosec\n${issues.length} issues found\n`;

            if (issues.length > 0) {
              const highIssues = issues.filter(i => i.severity === 'HIGH');
              const mediumIssues = issues.filter(i => i.severity === 'MEDIUM');
              const lowIssues = issues.filter(i => i.severity === 'LOW');

              comment += `- High: ${highIssues.length}\n`;
              comment += `- Medium: ${mediumIssues.length}\n`;
              comment += `- Low: ${lowIssues.length}\n\n`;
            }
          }

          // Check for trufflehog results
          if (fs.existsSync(`${path}/trufflehog-report.json`)) {
            const trufflehogReport = JSON.parse(fs.readFileSync(`${path}/trufflehog-report.json`, 'utf8'));
            const secrets = trufflehogReport.results || [];
            comment += `### Secrets Detection\n${secrets.length} potential secrets found\n\n`;

            if (secrets.length > 0) {
              comment += 'âš ï¸ **Potential secrets detected. Please review immediately.**\n\n';
            }
          }

          comment += 'Full reports are available in the [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Check for high severity issues
      run: |
        EXIT_CODE=0
        
        if [ -f "security-reports/gosec-report.json" ]; then
          HIGH_ISSUES=$(jq '[.Issues[] | select(.severity == "HIGH")] | length' security-reports/gosec-report.json 2>/dev/null || echo "0")
          CRITICAL_ISSUES=$(jq '[.Issues[] | select(.severity == "CRITICAL")] | length' security-reports/gosec-report.json 2>/dev/null || echo "0")
          
          if [ "$HIGH_ISSUES" -gt 0 ] || [ "$CRITICAL_ISSUES" -gt 0 ]; then
            echo "âŒ Critical/High severity security issues found:"
            echo "   - Critical: $CRITICAL_ISSUES"
            echo "   - High: $HIGH_ISSUES"
            echo "Please review and fix these issues before merging."
            EXIT_CODE=1
          fi
        fi

        if [ -f "security-reports/trufflehog-report.json" ]; then
          SECRETS_FOUND=$(jq '.results | length' security-reports/trufflehog-report.json 2>/dev/null || echo "0")
          if [ "$SECRETS_FOUND" -gt 0 ]; then
            echo "âŒ Potential secrets found in code: $SECRETS_FOUND"
            echo "Please remove any secrets before merging."
            EXIT_CODE=1
          fi
        fi
        
        exit $EXIT_CODE

    - name: Create security issue on failure
      if: failure() && github.event_name == 'push'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = './security-reports';
          
          let issueBody = `## ðŸ”’ Security Scan Failed\n\n`;
          issueBody += `**Branch:** \`${context.ref}\`\n`;
          issueBody += `**Commit:** ${context.sha}\n`;
          issueBody += `**Author:** @${context.actor}\n`;
          issueBody += `**Workflow:** [View Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n`;
          issueBody += `### Issues Found\n\n`;
          
          // Parse gosec results
          if (fs.existsSync(`${path}/gosec-report.json`)) {
            try {
              const gosecReport = JSON.parse(fs.readFileSync(`${path}/gosec-report.json`, 'utf8'));
              const issues = gosecReport.Issues || [];
              const highIssues = issues.filter(i => i.severity === 'HIGH');
              const criticalIssues = issues.filter(i => i.severity === 'CRITICAL');
              
              if (criticalIssues.length > 0 || highIssues.length > 0) {
                issueBody += `#### Gosec Security Issues\n`;
                issueBody += `- Critical: ${criticalIssues.length}\n`;
                issueBody += `- High: ${highIssues.length}\n\n`;
                
                if (criticalIssues.length > 0) {
                  issueBody += `**Critical Issues:**\n`;
                  criticalIssues.slice(0, 5).forEach(issue => {
                    issueBody += `- \`${issue.rule_id}\`: ${issue.details} (${issue.file}:${issue.line})\n`;
                  });
                  issueBody += `\n`;
                }
              }
            } catch (e) {
              console.log('Error parsing gosec report:', e);
            }
          }
          
          // Parse trufflehog results
          if (fs.existsSync(`${path}/trufflehog-report.json`)) {
            try {
              const trufflehogData = fs.readFileSync(`${path}/trufflehog-report.json`, 'utf8');
              const lines = trufflehogData.trim().split('\n').filter(l => l);
              if (lines.length > 0) {
                issueBody += `#### Secrets Detection\n`;
                issueBody += `âš ï¸ ${lines.length} potential secrets detected\n\n`;
              }
            } catch (e) {
              console.log('Error parsing trufflehog report:', e);
            }
          }
          
          issueBody += `### Action Required\n\n`;
          issueBody += `1. Review the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;
          issueBody += `2. Fix all critical and high severity issues\n`;
          issueBody += `3. Remove any exposed secrets\n`;
          issueBody += `4. Re-run security scans to verify fixes\n\n`;
          issueBody += `---\n*This issue was automatically created by the security scan workflow.*`;
          
          // Check for existing open security issues
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'security,automated'
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes('Security Scan Failed')
          );
          
          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”’ Security Scan Failed - Action Required',
              body: issueBody,
              labels: ['security', 'critical', 'automated'],
              assignees: [context.actor]
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `### New Security Issues Detected\n\n${issueBody}`
            });
          }

  dependency-check:
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Run dependency vulnerability check
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        echo "Checking for dependency vulnerabilities..."
        govulncheck ./...
        if [ $? -ne 0 ]; then
          echo "âŒ Dependency vulnerabilities found"
          exit 1
        fi

    - name: Check for outdated dependencies
      run: |
        go list -u -m -json all | grep -E '"Path"|"Version"|"Time"' > dependency-report.txt || true
        echo "Dependency report:"
        cat dependency-report.txt

    - name: Upload dependency report
      uses: actions/upload-artifact@v3
      with:
        name: dependency-report
        path: dependency-report.txt
        retention-days: 30